name: iOS CI/CD

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*' # Trigger on version tags like v1.0.0
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: macos-latest # iOS builds require macOS runners

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use a Node.js version compatible with your React Native project

      - name: Install npm dependencies
        run: npm install

      - name: Install CocoaPods
        run: |
          cd ios && pod install && cd ..

      - name: Set up Xcode version (optional)
        # Uncomment and adjust if you need a specific Xcode version, e.g., '15.0'
        # uses: maxim-sokolov/action-setup-xcode@v1
        # with:
        #   xcode-version: 'YOUR_XCODE_VERSION'
        run: |
          echo "Xcode setup skipped. Uncomment 'uses: maxim-sokolov/action-setup-xcode@v1' and configure 'xcode-version' if a specific Xcode version is needed."

      - name: Decode Apple Provisioning Profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ./ios/profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles/
          cp ./ios/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Decode Apple Signing Certificate
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          echo "$IOS_P12_BASE64" | base64 --decode > ./ios/certificate.p12
          security create-keychain -p github-actions github-actions.keychain
          security default-keychain -s github-actions.keychain
          security unlock-keychain -p github-actions github-actions.keychain
          security import ./ios/certificate.p12 -k github-actions.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k github-actions github-actions.keychain

      - name: Build and Archive iOS App
        run: |
          cd ios
          xcodebuild clean archive \
            -workspace SparkyFitnessMobile.xcworkspace \
            -scheme SparkyFitnessMobile \
            -configuration Release \
            -archivePath build/SparkyFitnessMobile.xcarchive \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE="Manual" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_NAME }}" \
            CODE_SIGN_IDENTITY="${{ env.DEVELOPER_NAME }}"
          cd ..
        env:
          # Replace with your actual bundle identifier
          BUNDLE_IDENTIFIER: com.yourcompany.sparkyfitnessmobile
          # Replace with your actual provisioning profile name (e.g., "My App Distribution Profile")
          PROVISIONING_PROFILE_NAME: "YOUR_PROVISIONING_PROFILE_NAME"
          # Replace with your actual developer name and team ID (e.g., "Apple Distribution: Your Name (TEAMID)")
          DEVELOPER_NAME: "Apple Distribution: YOUR_DEVELOPER_NAME (YOUR_TEAM_ID)"

      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/SparkyFitnessMobile.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ipa
          cd ..

      - name: Create Release (on tag push)
        id: create_release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ios/build/ipa/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload IPA as artifact (for all builds)
        uses: actions/upload-artifact@v4
        with:
          name: SparkyFitnessMobile-IPA
          path: ios/build/ipa/*.ipa
