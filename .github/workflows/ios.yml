name: iOS IPA on Release (AltStore)

on:
  release:
    types: [published]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      # 1️⃣ Checkout code at the release tag
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      # 2️⃣ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3️⃣ Install JS dependencies
      - name: Install npm dependencies
        run: npm install

      # 4️⃣ Install CocoaPods
      - name: Install CocoaPods
        working-directory: SparkyFitnessMobile/ios
        run: |
          pod install

      # 5️⃣ Build iOS app (UNSIGNED – free account)
      - name: Build iOS App (Unsigned)
        working-directory: SparkyFitnessMobile/ios
        run: |
          xcodebuild clean archive \
            -workspace SparkyFitnessMobile.xcworkspace \
            -scheme SparkyFitnessMobile \
            -configuration Release \
            -archivePath build/SparkyFitnessMobile.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      # 6️⃣ Export unsigned IPA
      - name: Export Unsigned IPA
        working-directory: SparkyFitnessMobile/ios
        run: |
          mkdir -p build/ipa
          xcodebuild -exportArchive \
            -archivePath build/SparkyFitnessMobile.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist /dev/null

      # 7️⃣ Attach IPA to GitHub Release
      - name: Upload IPA to Release
        uses: softprops/action-gh-release@v1
        with:
          files: SparkyFitnessMobile/ios/build/ipa/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
