name: iOS IPA on Release (AltStore)

on:
  release:
    types: [published]

jobs:
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout code at the release tag
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      # 2Ô∏è‚É£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # üìã Print key environment versions for easier debugging
      - name: Print environment versions
        run: |
          echo "Node: $(node -v)"
          echo "NPM: $(npm -v)"
          echo "Ruby: $(ruby -v || true)"
          echo "Gem: $(gem --version || true)"
          echo "CocoaPods: $(pod --version || true)"
          echo "Xcode: $(xcodebuild -version || true)"

      # 3Ô∏è‚É£ Install JS dependencies
      - name: Install npm dependencies
        run: npm install

      # 3.1Ô∏è‚É£ Cache Mobile node modules
      - name: Cache Mobile node modules
        uses: actions/cache@v4
        with:
          path: SparkyFitnessMobile/node_modules
          key: ${{ runner.os }}-sparky-mobile-${{ hashFiles('SparkyFitnessMobile/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-sparky-mobile-

      # 3.2Ô∏è‚É£ Install Mobile JS dependencies (needed for Pod install)
      - name: Install Mobile JS dependencies
        working-directory: SparkyFitnessMobile
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --progress=false
          else
            npm install --no-audit --progress=false
          fi
          npx expo prebuild --platform ios

      # 4Ô∏è‚É£ Cache CocoaPods spec repo
      - name: Cache CocoaPods spec repo
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cocoapods/repos
            $HOME/Library/Caches/CocoaPods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('SparkyFitnessMobile/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      # 4.1Ô∏è‚É£ Ensure CocoaPods is installed
      - name: Ensure CocoaPods is installed
        run: |
          if ! command -v pod >/dev/null; then
            gem install cocoapods --no-document
          fi

      # 4.2Ô∏è‚É£ Install CocoaPods
      - name: Install CocoaPods
        working-directory: SparkyFitnessMobile/ios
        run: |
          pod install --repo-update

      - name: List iOS Pods and Podfile.lock
        working-directory: SparkyFitnessMobile/ios
        run: |
          ls -la
          ls -la Pods || true
          cat Podfile.lock || true

      # 5Ô∏è‚É£ Build iOS app (UNSIGNED ‚Äì free account)
      - name: Build iOS App (Unsigned)
        working-directory: SparkyFitnessMobile/ios
        run: |
          xcodebuild clean archive \
            -workspace SparkyFitnessMobile.xcworkspace \
            -scheme SparkyFitnessMobile \
            -configuration Release \
            -archivePath build/SparkyFitnessMobile.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      # 6Ô∏è‚É£ Export unsigned IPA
      - name: Export Unsigned IPA
        working-directory: SparkyFitnessMobile/ios
        run: |
          mkdir -p build/ipa
          ARCHIVE_PATH=build/SparkyFitnessMobile.xcarchive
          APP_PATH="$ARCHIVE_PATH/Products/Applications/SparkyFitnessMobile.app"
          IPA_DIR=build/ipa

          # Create an unsigned IPA by packaging the .app inside the xcarchive
          if [ -d "$APP_PATH" ]; then
            # Ad-Hoc sign the app with entitlements before packaging
            # We sign frameworks first (no entitlements), then the main app (with entitlements)
            # This is more robust than --deep
            echo "Signing frameworks..."
            find "$APP_PATH/Frameworks" -type d -name "*.framework" | while read -r framework; do
              codesign -s - --force --preserve-metadata=identifier,entitlements "$framework"
            done
            
            echo "Preparing Entitlements for AltStore (Injecting get-task-allow)..."
            # specific fix for AltStore/Free Dev Account: They need get-task-allow=true (Development signing)
            # but Release builds default to false. We simply append it to a temp entitlements file.
            cp SparkyFitnessMobile/SparkyFitnessMobile.entitlements temp.entitlements
            /usr/libexec/PlistBuddy -c "Add :get-task-allow bool true" temp.entitlements || echo "get-task-allow already exists"

            echo "Applying Ad-Hoc signature to App binary with MODIFIED entitlements..."
            # Sign the main binary EXPLICITLY with DER entitlements using the TEMP file
            codesign -s - --entitlements temp.entitlements --force --generate-entitlement-der "$APP_PATH/SparkyFitnessMobile"
            
            echo "Applying Ad-Hoc signature to App Bundle..."
            # Sign the bundle wrapper as well to ensure consistent signature depth
            codesign -s - --entitlements temp.entitlements --force --generate-entitlement-der "$APP_PATH"

            # VERIFY the entitlements were applied
            echo "Verifying Entitlements on Binary:"
            codesign -d --entitlements :- "$APP_PATH/SparkyFitnessMobile"

            rm -rf Payload
            mkdir -p Payload
            cp -R "$APP_PATH" Payload/
            # Use ditto to create an IPA that preserves resource forks
            /usr/bin/ditto -c -k --sequesterRsrc --keepParent Payload "$IPA_DIR/SparkyFitnessMobile-unsigned.ipa"
            rm -rf Payload
          else
            echo "App not found at $APP_PATH"
            ls -la "$ARCHIVE_PATH"
            exit 1
          fi
      - name: List IPA files
        working-directory: SparkyFitnessMobile/ios
        run: ls -la build/ipa || true
      - name: Ensure IPA exists
        run: test -n "$(ls SparkyFitnessMobile/ios/build/ipa/*.ipa 2>/dev/null)" || (echo "No IPA found" && exit 1)

      # 7Ô∏è‚É£ Attach IPA to GitHub Release
      - name: Upload IPA to Release
        uses: softprops/action-gh-release@v1
        with:
          files: SparkyFitnessMobile/ios/build/ipa/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
