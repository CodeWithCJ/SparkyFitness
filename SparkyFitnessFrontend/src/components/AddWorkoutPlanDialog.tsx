import React, { useState, useEffect, useCallback } from "react";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { WorkoutPlanTemplate, WorkoutPlanAssignment, WorkoutPreset, WorkoutPresetSet } from "@/types/workout";
import { Checkbox } from "@/components/ui/checkbox";
import { Button } from "@/components/ui/button";
import { Plus, X, Repeat, Weight, Timer, ListOrdered, CalendarDays, GripVertical, Copy, Dumbbell, Hourglass } from "lucide-react";
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, sortableKeyboardCoordinates, arrayMove, useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { getWorkoutPresets } from "@/services/workoutPresetService";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { loadExercises } from "@/services/exerciseService";
import { Exercise } from "@/services/exerciseSearchService";
import { useAuth } from "@/hooks/useAuth";
import { toast } from "@/hooks/use-toast";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter, DialogClose } from "@/components/ui/dialog";
import AddExerciseDialog from "@/components/AddExerciseDialog";

interface AddWorkoutPlanDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (newPlan: Omit<WorkoutPlanTemplate, 'id' | 'user_id' | 'created_at' | 'updated_at'>) => void;
  initialData?: WorkoutPlanTemplate | null;
  onUpdate?: (planId: string, updatedPlan: Partial<WorkoutPlanTemplate>) => void;
}

const daysOfWeek = [
  { id: 0, name: "Sunday" },
  { id: 1, name: "Monday" },
  { id: 2, name: "Tuesday" },
  { id: 3, name: "Wednesday" },
  { id: 4, name: "Thursday" },
  { id: 5, name: "Friday" },
  { id: 6, name: "Saturday" },
];

const SortableSetItem = React.memo(({ set, assignmentIndex, setIndex, handleSetChangeInPlan, handleDuplicateSetInPlan, handleRemoveSetInPlan }: { set: WorkoutPresetSet, assignmentIndex: number, setIndex: number, handleSetChangeInPlan: Function, handleDuplicateSetInPlan: Function, handleRemoveSetInPlan: Function }) => {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: `set-${assignmentIndex}-${setIndex}` });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div ref={setNodeRef} style={style} className="flex flex-col space-y-2" {...attributes}>
      <div className="flex items-center space-x-2">
        <div {...listeners}>
          <GripVertical className="h-5 w-5 text-muted-foreground cursor-grab" />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-8 gap-2 flex-grow items-center">
          <div className="md:col-span-1">
            <Label>Set</Label>
            <p className="font-medium p-2">{set.set_number}</p>
          </div>
          <div className="md:col-span-2">
            <Label>Type</Label>
            <Select value={set.set_type} onValueChange={(value) => handleSetChangeInPlan(assignmentIndex, setIndex, 'set_type', value)}>
              <SelectTrigger>
                <SelectValue placeholder="Set Type" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="Working Set">Working Set</SelectItem>
                <SelectItem value="Warm-up">Warm-up</SelectItem>
                <SelectItem value="Drop Set">Drop Set</SelectItem>
                <SelectItem value="Failure">Failure</SelectItem>
                <SelectItem value="AMRAP">AMRAP</SelectItem>
                <SelectItem value="Back-off">Back-off</SelectItem>
                <SelectItem value="Rest-Pause">Rest-Pause</SelectItem>
                <SelectItem value="Cluster">Cluster</SelectItem>
                <SelectItem value="Technique">Technique</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div className="md:col-span-1">
            <Label htmlFor={`reps-${assignmentIndex}-${setIndex}`} className="flex items-center">
              <Repeat className="h-4 w-4 mr-1" style={{ color: '#3b82f6' }} /> Reps
            </Label>
            <Input id={`reps-${assignmentIndex}-${setIndex}`} type="number" value={set.reps ?? ''} onChange={(e) => handleSetChangeInPlan(assignmentIndex, setIndex, 'reps', Number(e.target.value))} />
          </div>
          <div className="md:col-span-1">
            <Label htmlFor={`weight-${assignmentIndex}-${setIndex}`} className="flex items-center">
              <Dumbbell className="h-4 w-4 mr-1" style={{ color: '#ef4444' }} /> Weight
            </Label>
            <Input id={`weight-${assignmentIndex}-${setIndex}`} type="number" value={set.weight ?? ''} onChange={(e) => handleSetChangeInPlan(assignmentIndex, setIndex, 'weight', Number(e.target.value))} />
          </div>
          <div className="md:col-span-1">
            <Label htmlFor={`duration-${assignmentIndex}-${setIndex}`} className="flex items-center">
              <Timer className="h-4 w-4 mr-1" style={{ color: '#f97316' }} /> Duration (min)
            </Label>
            <Input id={`duration-${assignmentIndex}-${setIndex}`} type="number" value={set.duration ?? ''} onChange={(e) => handleSetChangeInPlan(assignmentIndex, setIndex, 'duration', Number(e.target.value))} />
          </div>
          <div className="md:col-span-1">
            <Label htmlFor={`rest-${assignmentIndex}-${setIndex}`} className="flex items-center">
              <Timer className="h-4 w-4 mr-1" style={{ color: '#8b5cf6' }} /> Rest (s)
            </Label>
            <Input id={`rest-${assignmentIndex}-${setIndex}`} type="number" value={set.rest_time ?? ''} onChange={(e) => handleSetChangeInPlan(assignmentIndex, setIndex, 'rest_time', Number(e.target.value))} />
          </div>
          <div className="flex items-center space-x-1">
            <Button variant="ghost" size="icon" onClick={() => handleDuplicateSetInPlan(assignmentIndex, setIndex)}>
              <Copy className="h-4 w-4" />
            </Button>
            <Button variant="ghost" size="icon" onClick={() => handleRemoveSetInPlan(assignmentIndex, setIndex)}>
              <X className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </div>
      <div className="pl-8">
        <Label htmlFor={`notes-${assignmentIndex}-${setIndex}`}>Notes</Label>
        <Textarea id={`notes-${assignmentIndex}-${setIndex}`} value={set.notes ?? ''} onChange={(e) => handleSetChangeInPlan(assignmentIndex, setIndex, 'notes', e.target.value)} />
      </div>
    </div>
  );
});

const AddWorkoutPlanDialog: React.FC<AddWorkoutPlanDialogProps> = ({ isOpen, onClose, onSave, initialData, onUpdate }) => {
  const { user } = useAuth();
  const [planName, setPlanName] = useState("");
  const [description, setDescription] = useState("");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [isActive, setIsActive] = useState(true);
  const [assignments, setAssignments] = useState<WorkoutPlanAssignment[]>([]);
  const [workoutPresets, setWorkoutPresets] = useState<WorkoutPreset[]>([]);
  const [exercises, setExercises] = useState<Exercise[]>([]);
  const [isAddExerciseDialogOpen, setIsAddExerciseDialogOpen] = useState(false);
  const [selectedDayForAssignment, setSelectedDayForAssignment] = useState<number | null>(null);

  useEffect(() => {
    if (isOpen) {
      if (user?.id) {
        fetchPresetsAndExercises();
      }

      if (initialData) {
        setPlanName(initialData.plan_name);
        setDescription(initialData.description);
        setStartDate(initialData.start_date ? new Date(initialData.start_date).toISOString().split('T')[0] : '');
        setEndDate(initialData.end_date ? new Date(initialData.end_date).toISOString().split('T')[0] : '');
        setIsActive(initialData.is_active);
        setAssignments(initialData.assignments || []);
      } else {
        setPlanName("");
        setDescription("");
        setStartDate(new Date().toISOString().split('T')[0]);
        const today = new Date();
        today.setDate(today.getDate() + 7);
        setEndDate(today.toISOString().split('T')[0]);
        setIsActive(true);
        setAssignments([]);
      }
    } else {
      setPlanName("");
      setDescription("");
      setStartDate(new Date().toISOString().split('T')[0]);
      const today = new Date();
      today.setDate(today.getDate() + 7);
      setEndDate(today.toISOString().split('T')[0]);
      setIsActive(true);
      setAssignments([]);
    }
  }, [isOpen, user?.id, initialData]);

  const fetchPresetsAndExercises = async () => {
    if (!user?.id) return;
    try {
      const [presets, { exercises: fetchedExercises }] = await Promise.all([
        getWorkoutPresets(),
        loadExercises(user.id),
      ]);
      setWorkoutPresets(presets);
      setExercises(fetchedExercises);
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to load workout presets or exercises.",
        variant: "destructive",
      });
      console.error("Error fetching presets or exercises:", error);
    }
  };

  const handleRemoveAssignment = (index: number) => {
    setAssignments((prev) => prev.filter((_, i) => i !== index));
  };

  const handleAssignmentChange = (index: number, field: keyof WorkoutPlanAssignment, value: any) => {
    setAssignments(prev => prev.map((a, i) => i === index ? { ...a, [field]: value } : a));
  };

  const handleSetChangeInPlan = useCallback((assignmentIndex: number, setIndex: number, field: keyof WorkoutPresetSet, value: any) => {
    setAssignments(prev =>
      prev.map((assignment, aIndex) => {
        if (aIndex !== assignmentIndex || !assignment.sets) {
          return assignment;
        }
        return {
          ...assignment,
          sets: assignment.sets.map((set, sIndex) => {
            if (sIndex !== setIndex) {
              return set;
            }
            return { ...set, [field]: value };
          }),
        };
      })
    );
  }, []);

  const handleAddSetInPlan = useCallback((assignmentIndex: number) => {
    setAssignments(prev =>
      prev.map((assignment, aIndex) => {
        if (aIndex !== assignmentIndex || !assignment.sets || assignment.sets.length === 0) {
          return assignment;
        }
        const lastSet = assignment.sets[assignment.sets.length - 1];
        const newSet: WorkoutPresetSet = {
          ...lastSet,
          set_number: assignment.sets.length + 1,
        };
        return {
          ...assignment,
          sets: [...assignment.sets, newSet],
        };
      })
    );
  }, []);

  const handleDuplicateSetInPlan = useCallback((assignmentIndex: number, setIndex: number) => {
    setAssignments(prev =>
      prev.map((assignment, aIndex) => {
        if (aIndex !== assignmentIndex || !assignment.sets) {
          return assignment;
        }
        const sets = assignment.sets;
        const setToDuplicate = sets[setIndex];
        const newSets = [
          ...sets.slice(0, setIndex + 1),
          { ...setToDuplicate },
          ...sets.slice(setIndex + 1)
        ].map((s, i) => ({ ...s, set_number: i + 1 }));
        return { ...assignment, sets: newSets };
      })
    );
  }, []);

  const handleRemoveSetInPlan = useCallback((assignmentIndex: number, setIndex: number) => {
    setAssignments(prev =>
      prev.map((assignment, aIndex) => {
        if (aIndex !== assignmentIndex || !assignment.sets) {
          return assignment;
        }
        const newSets = assignment.sets.filter((_, sIndex) => sIndex !== setIndex)
                                       .map((s, i) => ({ ...s, set_number: i + 1 }));
        return { ...assignment, sets: newSets };
      }).filter(assignment => !assignment.exercise_id || (assignment.sets && assignment.sets.length > 0))
    );
  }, []);

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragEnd = useCallback((event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      const activeId = String(active.id);
      const overId = String(over.id);

      const [activeType, activeAssignmentIndexStr, activeSetIndexStr] = activeId.split('-');
      const [overType, overAssignmentIndexStr, overSetIndexStr] = overId.split('-');

      if (activeType !== 'set' || overType !== 'set' || activeAssignmentIndexStr !== overAssignmentIndexStr) {
        return;
      }

      const assignmentIndex = parseInt(activeAssignmentIndexStr, 10);
      const oldIndex = parseInt(activeSetIndexStr, 10);
      const newIndex = parseInt(overSetIndexStr, 10);

      if (isNaN(assignmentIndex) || isNaN(oldIndex) || isNaN(newIndex)) {
        return;
      }

      setAssignments((items) =>
        items.map((assignment, index) => {
          if (index === assignmentIndex && assignment.sets) {
            const reorderedSets = arrayMove(assignment.sets, oldIndex, newIndex);
            return {
              ...assignment,
              sets: reorderedSets.map((set, index) => ({ ...set, set_number: index + 1 })),
            };
          }
          return assignment;
        })
      );
    }
  }, []);

  const handleAddExerciseOrPreset = (
    item: Exercise | WorkoutPreset,
    sourceMode: 'internal' | 'external' | 'custom' | 'preset'
  ) => {
    if (selectedDayForAssignment !== null) {
      if (sourceMode === 'preset') {
        const preset = item as WorkoutPreset;
        setAssignments((prev) => [
          ...prev,
          {
            day_of_week: selectedDayForAssignment,
            template_id: '',
            workout_preset_id: preset.id,
            exercise_id: undefined,
            sets: [], // Presets are expanded on the backend
          },
        ]);
      } else {
        const exercise = item as Exercise;
        setAssignments((prev) => [
          ...prev,
          {
            day_of_week: selectedDayForAssignment,
            template_id: '',
            workout_preset_id: undefined,
            exercise_id: exercise.id,
            exercise_name: exercise.name,
            sets: [{ set_number: 1, set_type: 'Working Set', reps: 10, weight: 0 }],
          },
        ]);
      }
      setIsAddExerciseDialogOpen(false);
      setSelectedDayForAssignment(null);
    }
  };

  const handleSave = () => {
    if (planName.trim() === "" || startDate.trim() === "") {
      toast({
        title: "Validation Error",
        description: "Plan Name and Start Date are required.",
        variant: "destructive",
      });
      return;
    }

    const assignmentsToSave = assignments.filter(
      (assignment) => assignment.workout_preset_id || assignment.exercise_id
    );

    const planData = {
      plan_name: planName,
      description: description,
      start_date: startDate,
      end_date: endDate || null,
      is_active: isActive,
      assignments: assignmentsToSave,
    };

    if (initialData && onUpdate) {
      onUpdate(initialData.id, planData);
    } else if (onSave) {
      onSave(planData);
    }
    onClose();
  };


  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <TooltipProvider>
      <DialogContent className="sm:max-w-[1200px] max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>{initialData ? "Edit Workout Plan" : "Add New Workout Plan"}</DialogTitle>
          <DialogDescription>
            {initialData ? "Edit the details for your workout plan and its assignments." : "Enter the details for your new workout plan and assign workouts to days."}
          </DialogDescription>
        </DialogHeader>
        <div className="grid gap-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="planName">
              Plan Name
            </Label>
            <Input
              id="planName"
              value={planName}
              onChange={(e) => setPlanName(e.target.value)}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="description">
              Description
            </Label>
            <Textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="startDate">
                Start Date
              </Label>
              <div className="relative">
                <Input
                  id="startDate"
                  type="date"
                  value={startDate}
                  onChange={(e) => setStartDate(e.target.value)}
                  className="pr-8"
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label htmlFor="endDate">
                End Date (Optional)
              </Label>
              <div className="relative">
                <Input
                  id="endDate"
                  type="date"
                  value={endDate}
                  onChange={(e) => setEndDate(e.target.value)}
                  className="pr-8"
                />
              </div>
            </div>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="isActive"
              checked={isActive}
              onCheckedChange={(checked) => setIsActive(checked as boolean)}
            />
            <Label htmlFor="isActive">
              Set as active plan
            </Label>
          </div>
          <p className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-2" role="alert">
            <span className="font-bold">Note:</span> Saving an active plan updates future exercise entries. Deleting a plan removes future entries, but past entries remain in your log.
          </p>

          <div className="space-y-4">
            <h4 className="mb-2 text-lg font-medium">Assignments</h4>
            <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
              {daysOfWeek.map((day) => (
                <Card key={day.id}>
                  <CardHeader>
                    <CardTitle>{day.name}</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-4">
                      {assignments
                        .map((assignment, index) => ({ assignment, originalIndex: index }))
                        .filter(({ assignment }) => assignment.day_of_week === day.id)
                        .map(({ assignment, originalIndex }) => (
                          <div key={originalIndex} className="border p-4 rounded-md space-y-4">
                            {assignment.workout_preset_id ? (
                              <div className="flex items-center justify-between">
                                <span className="font-medium">
                                  Preset: {workoutPresets.find(p => p.id === assignment.workout_preset_id)?.name || "N/A"}
                                </span>
                                <Button variant="ghost" size="icon" onClick={() => handleRemoveAssignment(originalIndex)}>
                                  <X className="h-4 w-4" />
                                </Button>
                              </div>
                            ) : (
                              <>
                                <div className="flex items-center justify-between">
                                  <h4 className="font-semibold">{assignment.exercise_name}</h4>
                                  <Button variant="ghost" size="icon" onClick={() => handleRemoveAssignment(originalIndex)}>
                                    <X className="h-4 w-4" />
                                  </Button>
                                </div>
                                <SortableContext items={assignment.sets.map((_, index) => `set-${originalIndex}-${index}`)}>
                                  <div className="space-y-2">
                                    {assignment.sets.map((set, setIndex) => (
                                      <SortableSetItem
                                        key={`set-${originalIndex}-${setIndex}`}
                                        set={set}
                                        assignmentIndex={originalIndex}
                                        setIndex={setIndex}
                                        handleSetChangeInPlan={handleSetChangeInPlan}
                                        handleDuplicateSetInPlan={handleDuplicateSetInPlan}
                                        handleRemoveSetInPlan={handleRemoveSetInPlan}
                                      />
                                    ))}
                                  </div>
                                </SortableContext>
                                <Button type="button" variant="outline" onClick={() => handleAddSetInPlan(originalIndex)}>
                                  <Plus className="h-4 w-4 mr-2" /> Add Set
                                </Button>
                              </>
                            )}
                          </div>
                        ))}
                    </div>
                    <div className="flex space-x-2 mt-4">
                      <Button variant="outline" size="sm" onClick={() => {
                        setSelectedDayForAssignment(day.id);
                        setIsAddExerciseDialogOpen(true);
                      }}>
                        <Plus className="h-4 w-4 mr-2" /> Add Exercise/Preset
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </DndContext>
          </div>
         </div>
         <DialogFooter>
           <DialogClose asChild>
             <Button variant="outline" onClick={onClose}>Cancel</Button>
           </DialogClose>
           <Button onClick={handleSave}>Save Plan</Button>
         </DialogFooter>
       </DialogContent>
 
       <Dialog open={isAddExerciseDialogOpen} onOpenChange={setIsAddExerciseDialogOpen}>
         <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
           <DialogHeader>
             <DialogTitle>Add Exercise or Preset</DialogTitle>
             <DialogDescription>
               Select an exercise or a preset to add to the selected day.
             </DialogDescription>
           </DialogHeader>
           <AddExerciseDialog
             open={isAddExerciseDialogOpen}
             onOpenChange={setIsAddExerciseDialogOpen}
             onExerciseAdded={(exercise, sourceMode) => handleAddExerciseOrPreset(exercise, sourceMode)}
             onWorkoutPresetSelected={(preset) => handleAddExerciseOrPreset(preset, 'preset')}
             mode="workout-plan"
           />
         </DialogContent>
       </Dialog>
      </TooltipProvider>
    </Dialog>
    );
  };

export default AddWorkoutPlanDialog;