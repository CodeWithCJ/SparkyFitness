# Environment Variables

This document provides a comprehensive list and detailed descriptions of all environment variables used by SparkyFitness. Proper configuration of these variables is crucial for the application to function as expected.

For a complete list of all available variables and their detailed descriptions, please refer to the example environment file:
[`.env.example` on GitHub](https://github.com/CodeWithCJ/SparkyFitness/blob/main/docker/.env.example)

## Essential Configuration

The following environment variables are **mandatory** and must be supplied for the application to start correctly. Failure to provide these will result in the server failing to launch.

*   **`SPARKY_FITNESS_DB_NAME`**: Your desired PostgreSQL database name (e.g., `sparkyfitness_db`).
*   **`SPARKY_FITNESS_DB_USER`**: Your desired PostgreSQL database user (e.g., `sparky`). This user is used for DB initialization and migrations.
*   **`SPARKY_FITNESS_DB_PASSWORD`**: A strong password for your PostgreSQL database.
*   **`SPARKY_FITNESS_APP_DB_USER`**: Application database user with limited privileges. It can be changed any time after initialization.
*   **`SPARKY_FITNESS_APP_DB_PASSWORD`**: Password for the application database user.
*   **`SPARKY_FITNESS_FRONTEND_URL`**: The public URL of your frontend (e.g., `http://localhost:8080` for local testing, or your domain like `https://fitness.example.com` for production). This is crucial for CORS security.
*   **`SPARKY_FITNESS_API_ENCRYPTION_KEY`**: A 64-character hex string for data encryption. You can generate one using `openssl rand -hex 32` or `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`.
    *   **`SPARKY_FITNESS_API_ENCRYPTION_KEY_FILE`**: (Optional) Path to a file containing the encryption key. Useful for Docker Swarm/Kubernetes secrets. When this variable is set, the application will read the encryption key from the specified file path. This allows for more secure secret management in containerized environments.
*   **`BETTER_AUTH_SECRET`**: A secret key used by Better Auth to sign sessions and tokens. Make this a long, random, and secure string. You can generate one using `openssl rand -hex 32` or `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`.
    *   **Note**: If this variable is not set, the server will **automatically generate** a temporary secret on startup to allow the application to run. However, this means that **all user sessions will be invalidated** whenever the server restarts. For a stable production environment, you **must** explicitly set this variable to a persistent value.

## Mandatory Volume Paths

These paths define where Docker volumes will store persistent data on your host. These are **mandatory** to prevent data loss if containers are removed. You can either define them in the `.env` file or directly in the `docker-compose.yml`.

*   **`DB_PATH`**: Path for PostgreSQL database data (e.g., `../postgresql`).
*   **`SERVER_BACKUP_PATH`**: Path for server backups (e.g., `./backup`).
*   **`SERVER_UPLOADS_PATH`**: Path for profile pictures and exercise images (e.g., `./uploads`).

## Optional Configuration

*   **`SPARKY_FITNESS_SERVER_HOST`**: The hostname or IP address of the backend server. This variable is primarily used by the Internal Nginx proxy (not to be confused with your proxy manager)  in the frontend container to correctly route API requests to the backend service. For Docker Compose, this defaults to `sparkyfitness-server` (the service name for inter-container communication). If running outside Docker Compose, you would typically set this to `localhost` or the server's IP.
*   **`SPARKY_FITNESS_SERVER_PORT`**: The server port (e.g., `3010`). This is the port on which the backend server listens. It defaults to `3010` if not explicitly set. This variable is also used by the Internal Nginx proxy (not to be confused with your proxy manager) in the frontend container.
*   **`SPARKY_FITNESS_LOG_LEVEL`**: Logging level for the server (e.g., `INFO`, `DEBUG`, `WARN`, `ERROR`).
*   **`NODE_ENV`**: Node.js environment mode (e.g., `development`, `production`, `test`). Set to `production` for deployment to ensure optimal performance and security.
*   **`TZ`**: Server timezone. Use a TZ database name (e.g., `America/New_York`, `Etc/UTC`).
*   **`SPARKY_FITNESS_DISABLE_SIGNUP`**: Set to `true` to disable new user registrations.
*   **`SPARKY_FITNESS_ADMIN_EMAIL`**: Set the email of a user to automatically grant admin privileges on server startup. If not set, no admin user will be created automatically.
*   **`SPARKY_FITNESS_FORCE_EMAIL_LOGIN`**: Set to `true` to force email/password login to be enabled, overriding any in-app settings. This is a fail-safe to prevent being locked out if OIDC is misconfigured.
*   **`ALLOW_PRIVATE_NETWORK_CORS`**: Set to `true` to allow Cross-Origin Resource Sharing (CORS) from private network addresses (e.g., `192.168.x.x`, `10.x.x.x`, `127.0.0.1`, `localhost`). This allows standard browser requests from local IPs. Use with caution.
*   **`SPARKY_FITNESS_EXTRA_TRUSTED_ORIGINS`**: A comma-separated list of additional URLs that Better Auth should trust (e.g., `http://192.168.1.175:8080,http://10.0.0.5:8080`). Use this if you are accessing the app from specific local IPs on your network and `ALLOW_PRIVATE_NETWORK_CORS` is enabled.

*   **Email Settings**: Configure these variables if you want to enable email notifications (e.g., for password resets). If not configured, email functionality will be disabled.
    *   **`SPARKY_FITNESS_EMAIL_HOST`**: SMTP host for sending emails (e.g., `smtp.example.com`).
    *   **`SPARKY_FITNESS_EMAIL_PORT`**: SMTP port (e.g., `587`).
    *   **`SPARKY_FITNESS_EMAIL_SECURE`**: Use `true` for TLS/SSL, `false` for plain text.
    *   **`SPARKY_FITNESS_EMAIL_USER`**: Your email username.
    *   **`SPARKY_FITNESS_EMAIL_PASS`**: Your email password.
    *   **`SPARKY_FITNESS_EMAIL_FROM`**: The 'from' email address.

*   **API Key Rate Limiting**: API keys (used by automation tools like n8n or the mobile app) are rate-limited to prevent abuse. The defaults are suitable for most use cases.
    *   **`SPARKY_FITNESS_API_KEY_RATELIMIT_WINDOW_MS`**: The time window in milliseconds for the rate limit counter. Defaults to `60000` (1 minute).
    *   **`SPARKY_FITNESS_API_KEY_RATELIMIT_MAX_REQUESTS`**: The maximum number of requests allowed per time window. Defaults to `100`.

*   **Garmin Integration**: If you require Garmin integration, uncomment the relevant section from the `docker-compose.yml` file and configure the following variables:
    *   **`GARMIN_MICROSERVICE_URL`**: The URL for the Garmin microservice (e.g., `http://sparkyfitness-garmin:8000`).
    *   **`GARMIN_SERVICE_PORT`**: This is used for Garmin Connect synchronization. Make sure this matches with `GARMIN_MICROSERVICE_URL`.
    *   **`GARMIN_SERVICE_IS_CN`**: Set to `true` for China region. Everything else should be `false`. Optional - defaults to `false`.

*   **AI Service Configuration**: Configure global AI service settings via environment variables. These settings are shared across all users and can be managed by administrators in the admin panel. When `SPARKY_FITNESS_AI_SYNC_ENV_TO_DB=true`, these variables are automatically synced to the database on server startup.
    *   **`SPARKY_FITNESS_AI_SERVICE_TYPE`**: The AI service provider type. Supported values: `openai`, `anthropic`, `google`, `mistral`, `groq`, `ollama`, `openai_compatible`, `custom`. Required if using environment variable configuration.
    *   **`SPARKY_FITNESS_AI_SERVICE_NAME`**: Display name for the AI service (e.g., `Organization OpenAI Service`). Required if using environment variable configuration.
    *   **`SPARKY_FITNESS_AI_API_KEY`**: API key for the AI service. Required for all service types except `ollama`. The API key will be encrypted when synced to the database.
    *   **`SPARKY_FITNESS_AI_MODEL_NAME`**: Model name to use (e.g., `gpt-4o`, `claude-3-5-sonnet-20241022`, `gemini-1.5-pro`). Optional - if not provided, a default model for the service type will be used.
    *   **`SPARKY_FITNESS_AI_CUSTOM_URL`**: Custom API endpoint URL. Required for `ollama`, `openai_compatible`, and `custom` service types. For Ollama, typically `http://localhost:11434`. For OpenAI-compatible services, use the base URL (e.g., `https://api.example.com/v1`).
    *   **`SPARKY_FITNESS_AI_SYSTEM_PROMPT`**: Optional custom system prompt to override the default. This will be added to the AI context in addition to the project documentation.
    *   **`SPARKY_FITNESS_AI_IS_ACTIVE`**: Set to `true` or `1` to activate this service as the default. Set to `false` or `0` to keep it inactive. Defaults to `true` if not specified.
    *   **`SPARKY_FITNESS_AI_SYNC_ENV_TO_DB`**: Set to `true` or `1` to automatically sync environment variables to the database as a global setting on server startup. When enabled, the database becomes the source of truth and can be managed via the admin panel. When disabled (default), environment variables are used directly as a fallback when no database global setting exists. Defaults to `false`.
    
    **Example Configuration:**
    ```bash
    # OpenAI Configuration
    SPARKY_FITNESS_AI_SERVICE_TYPE=openai
    SPARKY_FITNESS_AI_SERVICE_NAME=Organization OpenAI
    SPARKY_FITNESS_AI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    SPARKY_FITNESS_AI_MODEL_NAME=gpt-4o
    SPARKY_FITNESS_AI_IS_ACTIVE=true
    SPARKY_FITNESS_AI_SYNC_ENV_TO_DB=true
    
    # Ollama Configuration (Local)
    SPARKY_FITNESS_AI_SERVICE_TYPE=ollama
    SPARKY_FITNESS_AI_SERVICE_NAME=Local Ollama
    SPARKY_FITNESS_AI_CUSTOM_URL=http://localhost:11434
    SPARKY_FITNESS_AI_MODEL_NAME=llama2
    SPARKY_FITNESS_AI_IS_ACTIVE=true
    SPARKY_FITNESS_AI_SYNC_ENV_TO_DB=true
    ```
    
    **Note**: When `SPARKY_FITNESS_AI_SYNC_ENV_TO_DB=true`, the environment variables are synced to the database on startup. After sync, you can manage the global settings via the admin panel (`/admin`). If sync is disabled, environment variables serve as a read-only fallback when no database global setting exists.
    
    ### User AI Configuration Control
    
    - **`SPARKY_FITNESS_ALLOW_USER_AI_CONFIG`** (optional, default: `true`): Controls whether users can configure their own AI service settings. When set to `false`, users can only use the global AI service settings configured by administrators. When set to `true` (or not set), users can add and manage their own AI service configurations. This environment variable takes precedence over the database setting if set.
    
    ```bash
    # Disable per-user AI configuration (users can only use global settings)
    SPARKY_FITNESS_ALLOW_USER_AI_CONFIG=false
    
    # Allow users to configure their own AI services (default)
    SPARKY_FITNESS_ALLOW_USER_AI_CONFIG=true
    ```
